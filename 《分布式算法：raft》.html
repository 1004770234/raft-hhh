<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/603139 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="34293"/>

<div>
<span><div>0、相关资料：</div><div>1、<span style="font-size: unset; color: unset; font-family: unset;">重点：【</span><span style="font-size: unset; color: unset; font-family: unset; font-weight: bold;">264</span><span style="font-size: unset; color: unset; font-family: unset;">】、</span></div><div>2、问题：264、266、</div><div><br/></div><div><br/></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">日志快照</span></div><div><br/></div><div><br/></div><div><br/></div><div>259、①加速日志同步（如果一个节点落后太多）：日志快照</div><div><br/></div><div>260、<b><font style="color: rgb(227, 0, 0);">【何时生成日志快照+谁生成日志快照+日志快照的存储】</font></b></div><div>①<span style="font-weight: bold; color: rgb(50, 135, 18);">日志快照相当于【全量备份】，普通日志条目相当于【增量备份】</span></div><div>②日志快照触发条件</div><div>【1】超过数量</div><div>【2】定时备份</div><div>③<span style="font-weight: bold; color: rgb(222, 87, 0);">raft算法中没有指定由哪种节点生成日志快照</span>。换句话说，满足日志快照生成条件的节点，都可以自行生成日志快照。</div><div>（<span style="font-weight: bold;">最好让leader节点来</span>）</div><div>④【<span style="color: rgb(227, 0, 0); font-weight: bold;">上层服务负责生成日志快照。</span>】</div><div><span style="font-weight: bold; color: rgb(222, 87, 0);">核心组件不能直接生成日志快照，因为只有上层服务指导怎么生成，以及生成的内容是什么。</span></div><div>⑤日志代：<span style="font-weight: bold; color: rgb(50, 135, 18);">区分多次生成【日志快照】后的日志</span></div><div>【1】entries.bin：<span style="font-weight: bold;">具体</span>的日志条目</div><div>【2】entries.idx：日志条目的<span style="font-weight: bold;">元信息</span></div><div>【3】service.ss：日志快照文件</div><div><br/></div><div>261、<b><font style="color: rgb(227, 0, 0);">【日志快照的格式】</font></b></div><div>①<span style="font-weight: bold; color: rgb(222, 87, 0);">日志快照中</span><span style="font-weight: bold; color: rgb(50, 135, 18);">，最后一条日志的索引，是日志代名字的一部分。</span></div><div><span style="font-weight: bold; color: rgb(50, 135, 18);">（P261有图）</span></div><div>②因此服务器在启动时，<span style="font-weight: bold; color: rgb(222, 87, 0);">可以给这些日志代排序，选择lastIncludedIndex最大的那个</span>，也是最新的一个日志快照所在的日志代启动。</div><div>③日志快照生成频繁，占据空间</div><div><span style="font-weight: bold;">解决：创建新的日志代前，先删除几代之前的日志代。</span></div><div>④<span style="font-weight: bold; color: rgb(222, 87, 0);">日志快照和日志条目不同</span>，<span style="font-weight: bold; color: rgb(50, 135, 18);">是一个【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">生成之后就不会变化</span><span style="font-weight: bold; color: rgb(50, 135, 18);">】的文件，也就是【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">只读文件</span><span style="font-weight: bold; color: rgb(50, 135, 18);">】</span></div><div>⑤随机访问+预读文件头</div><div>⑥<span style="font-weight: bold; color: rgb(222, 87, 0);">文件头中的数据：用protocolBuffer进行序列化和反序列化</span></div><div><br/></div><div>262、<b><font style="color: rgb(227, 0, 0);">【日志快照的传输+日志快照的安装与生成】</font></b></div><div>①日志快照中，没有“内容长度”的字段，因为内容长度可以用【文件长度-文件头-文件头长度】来计算</div><div>②class InstallSnapshotRpc</div><div><span style="font-weight: bold; color: rgb(227, 0, 0);">③允许被交互多次的信息</span></div><div><span style="font-weight: bold;">    【1】因为日志快照比较大，无法一次传输所有数据。</span></div><div><span style="font-weight: bold;">    【2】添加了数据偏移offset和判断是否已经到达最后的done字段。</span></div><div>④<span style="font-weight: bold; color: rgb(222, 87, 0);">raft算法中没有给响应设置success字段。</span></div><div><span style="font-weight: bold; color: rgb(50, 135, 18);">【1】笔者认为是即使知道了安装失败，leader节点也无法做任何事</span></div><div>【2】而且只要leader节点的日志快照没有问题，理论上不会发生失败的情况。</div><div>【3】特殊情况：传输日志快照时，重新选举leader节点。</div><div>                则follower节点需要丢弃之前leader传输到一半的日志快照，接收来自新leader节点的日志快照。</div><div><br/></div><div>263、① <span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">InstallSnapshot消息可以传输多次<span style="font-family: 微软雅黑; font-size: medium; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; color: rgb(222, 87, 0);">，接收端需要在收到最后一条</span></span> <span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;"><span style="font-family: 微软雅黑; font-size: medium; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; color: rgb(222, 87, 0);">InstallSnapshot消息之前存放中途数据，</span>这增加了实现难度。</span></div><div>②generating：节点自己生成日志快照时使用</div><div>installing：收到来自leader节点的日志快照时使用</div><div><span style="font-weight: bold; color: rgb(222, 87, 0);">③理论上，两个日志文件夹可以同时操作。</span></div><div>因为数据来源不同，已给来自节点本身，另一个来自leader节点。</div><div>④收到来自leader的installSnapshot消息，并生成日志快照后，<span style="font-weight: bold; color: rgb(50, 135, 18);">需要比较【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">其</span><span style="font-weight: bold; color: rgb(50, 135, 18);">】和【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">节点自身的日志快照</span><span style="font-weight: bold; color: rgb(50, 135, 18);">】哪个更新。</span></div><div><span style="font-weight: bold;">此时需要获取锁，或者等待节点自身的日志快照生成完成。</span></div><div>⑤<span style="font-weight: bold; color: rgb(222, 87, 0);">KV服务使用了单独的线程来应用日志</span></div><div>KV服务的线程在应用完日志之后，自行判断是否需要生成日志快照</div><div>⑥在KV服务的线程中，生成日志快照</div><div>【1】可以避免不同线程访问KV服务的数据</div><div>【2】可以把生成日志快照这个比较耗时的操作，从主线程中分离</div><div>⑦<span style="font-weight: bold; color: rgb(222, 87, 0);">KV生成日志快照后，通知【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">主线程</span><span style="font-weight: bold; color: rgb(222, 87, 0);">】替换现有的日志快照。</span></div><div><span style="font-weight: bold; color: rgb(50, 135, 18);">主线程的日志组件</span>，判断<span style="font-weight: bold; color: rgb(50, 135, 18);">服务线程过来的数据</span>是否比现有的日志快照新。</div><div>（<span style="font-weight: bold; color: rgb(222, 87, 0);">必须判断，因为很可能同时有来自“</span><span style="color: rgb(222, 87, 0); font-weight: bold;">leader节点</span><span style="font-weight: bold; color: rgb(222, 87, 0);">”的日志快照</span>）</div><div><br/></div><div>264、①生成快照的同时应用日志+【<span style="font-weight: bold; color: rgb(227, 0, 0);">在KV服务中执行的顺序</span>】</div><div>②<span style="font-weight: bold; color: rgb(50, 135, 18);">问题：上层服务的数据，有可能比核心组件中的日志要旧</span></div><div><span style="font-weight: bold; color: rgb(50, 135, 18);">（图中有体现：核心服务先推进commitIndex，才会让KV服务线程应用日志。）</span></div><div>③日志IO的异步化：</div><div>日志快照必须和日志组件一起操作，因为【更新日志快照】必须同时修改【现有的日志】</div><div>⑤<b><font style="color: rgb(227, 0, 0);">对图的解释</font></b></div><div><b><font color="#DE5700">【1】service thread：KV服务的线程</font></b></div><div><b><font color="#DE5700">【2】main thread：核心组件</font></b></div><div><b><font color="#DE5700">【3】log io thread：</font></b></div><div><b><font color="#DE5700">【4】log component</font></b></div><div>⑥日志快照的更新</div><div>【1】日志快照生成过程中，新增的日志</div><div>【2】重置现有日志组件的日志快照和日志条目</div><div><br/></div><div>265、<b><font style="color: rgb(227, 0, 0);">【接收方实现+KV服务的数据快照】</font></b></div><div>①【4】如果没有接收完成（done=false），则回复和等待更多数据。</div><div>【6】<b><font style="color: rgb(50, 135, 18);">如果存在一条与【消息中索引和term一致】的日志，则保留之后的日志并回复</font></b></div><div>【7】丢弃所有日志</div><div>【8】使用日志快照重置状态机</div><div>②【<span style="font-weight: bold; color: rgb(222, 87, 0);">日志快照</span>】<b><font style="color: rgb(222, 87, 0);">需要和【</font></b><span style="font-weight: bold; color: rgb(222, 87, 0);">现有日志</span><b><font style="color: rgb(222, 87, 0);">】平行操作。</font></b></div><div>平行操作也不是完全的异步，处理过程中也需要判断现有日志状态。</div><div><b><font style="color: rgb(222, 87, 0);">设计上把日志快照和日志条目作为一个整体来处理比较好。</font></b></div><div>③数据快照：对于KV服务来说，就是当前情况下各个关键字和关键字所对应的值，</div><div><b><font style="color: rgb(222, 87, 0);">【</font></b><span style="font-weight: bold; color: rgb(222, 87, 0);">生成</span><b><font style="color: rgb(222, 87, 0);">】就相当于遍历当前的数据Map，【</font></b><span style="font-weight: bold; color: rgb(222, 87, 0);">恢复</span><b><font style="color: rgb(222, 87, 0);">】就是新建一个数据Map</font></b></div><div>④内容和二进制流之间相互转化：protocolBuffer</div><div>EntryList</div><div>生成数据快照：toSnapshot</div><div>从数据快照中恢复：fromSnapshot </div><div><br/></div><div>266、<b><font style="color: rgb(227, 0, 0);">【日志快照和现有日志条目】</font></b></div><div>①获取最后一条日志的索引和term时，有可能只有日志快照。</div><div>②<b><font style="color: rgb(222, 87, 0);">【匹配点】退到日志快照的索引时</font>，需要切换AppendRntries消息到InstallSnapshot消息。</b></div><div>③</div><div><br/></div><div>267、①基于内存的日志快照+基于文件的日志快照</div><div>②interface Snapshot：<b><font style="color: rgb(222, 87, 0);">【所有操作都是只读的】</font></b></div><div>③readData操作是针对InstallSnapshot消息的。</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #808000;">@Nonnull</span></div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span>SnapshotChunk readData(<span style="color: #000080; font-weight: bold;">int</span> offset, <span style="color: #000080; font-weight: bold;">int</span> length);</div><div>④class SnapshotChunk</div><div><br/></div><div>268、①日志快照有3种</div><div>【1】EmptySnapshot：空日志快照</div><div>【2】MemorySnapshot：内存日志快照</div><div>【3】FileSnapshot：文件日志快照</div><div><br/></div><div>272、①日志快照的写入，主要在生成和安装时发生</div><div><b><font style="color: rgb(222, 87, 0);">②本书在实现时，并没有把写入操作放在日志快照接口中，</font></b></div><div>【1】降低编码复杂度</div><div><b><font style="color: rgb(50, 135, 18);">【2】写入时，不会有读取操作</font></b></div><div>③写入接口：interface SnapshotBuilder</div><div>④<b><font style="color: rgb(222, 87, 0);">为了处理不同类型的日志快照</font></b>，T类型必须实现Snapshot接口</div><div><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-weight: bold;">public interface</span> SnapshotBuilder&lt;<b><font style="color: rgb(222, 87, 0);">T extends Snapshot</font></b>&gt; {</span></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-weight: bold;"><span>    </span>void</span> <span style="font-size: 9.8pt;">append(InstallSnapshotRpc rpc);</span><br/></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="font-size: 9.8pt; color: rgb(32, 153, 157);"><span>    </span>T</span> <span style="font-size: 9.8pt;">build();</span><br/></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-weight: bold;"><span>    </span>void</span> <span style="font-size: 9.8pt;">close();</span><span style="background-color: transparent; font-size: 9.8pt;">}</span></div><div>⑤<span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold;">abstract class</span> <span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font style="color: rgb(222, 87, 0);">AbstractSnapshotBuilder</font></b>&lt;</span><span style="background-color: #ffffff; color: #20999d; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt;">T</span> <span style="background-color: #ffffff; color: #000080; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt; font-weight: bold;">extends</span> <span style="background-color: #ffffff; color: #000000; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt;">Snapshot&gt;</span> <span style="background-color: #ffffff; color: #000080; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt; font-weight: bold;">implements</span> <span style="background-color: #ffffff; color: #000000; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt;">SnapshotBuilder&lt;</span><span style="background-color: #ffffff; color: #20999d; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt;">T</span><span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">&gt; {</span></div><div><br/></div><div>274、<b><font style="color: rgb(50, 135, 18);">基于文件的：实现比较困难</font></b></div><div><span style="background-color: #ffffff; color: #000080; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt; font-weight: bold;">public class</span> <span style="background-color: #ffffff; color: #000000; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt;">FileSnapshotBuilder</span> <span style="background-color: #ffffff; color: #000080; font-family: 'JetBrains Mono',monospace; font-size: 9.8pt; font-weight: bold;">extends</span> <span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">AbstractSnapshotBuilder&lt;FileSnapshot&gt; {</span></div><div><br/></div><div>276、<b><font style="color: rgb(227, 0, 0);">【日志快照的更新】</font></b></div><div>①只有在【生成完成后+安装数据就绪时】，才能更新现有日志快照</div><div>②<b><font style="color: rgb(222, 87, 0);">更新快照时，为了【</font></b><span style="font-weight: bold; color: rgb(222, 87, 0);">避免文件复制</span><b><font style="color: rgb(222, 87, 0);">】，一个简单的办法是【</font><font style="color: rgb(50, 135, 18);">给文件夹重命名</font><font style="color: rgb(222, 87, 0);">】</font></b></div><div><br/></div><div>277、<b><font style="color: rgb(227, 0, 0);">【日志快照的安装与应用】</font></b></div><div>①<b><font style="color: rgb(50, 135, 18);">比起【</font></b><span style="font-weight: bold; color: rgb(50, 135, 18);">发送方</span><b><font style="color: rgb(50, 135, 18);">】，【</font></b><span style="font-weight: bold; color: rgb(50, 135, 18);">处理方</span><b><font style="color: rgb(50, 135, 18);">】的操作相对简单一些</font></b></div><div>②以下是<b><font style="color: rgb(222, 87, 0);">核心组件</font></b>中处理InstallSnapshot消息的代码，</div><div>InstallSnapshot消息全权交给<b><font style="color: rgb(222, 87, 0);">【日志组件</font></b>】处理</div><div>③</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #808000;">@Override</span></div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;">public</span> InstallSnapshotState installSnapshot(InstallSnapshotRpc rpc) {</div><div><br/></div><div>278、</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="34291"/>

<div>
<span><div>0、相关资料：</div><div>1、<span style="font-size: unset; color: unset; font-family: unset;">重点：224、【234-237】，【238-257】</span></div><div>2、问题：223、224、225、228</div><div><br/></div><div><br/></div><div><br/></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">客户端和整体测试</span></div><div><br/></div><div><br/></div><div>223、①客户端需要满足的【特性】</div><div>【1】交互式</div><div>【2】<span style="font-weight: bold; color: rgb(222, 87, 0);">自动处理重定向</span>：中途重新选举后，leader可能有变化</div><div>【3<span style="font-weight: bold; color: rgb(222, 87, 0);">】自动同步集群成员列表+（或支持手动修改）</span></div><div>②<span style="font-weight: bold; color: rgb(50, 135, 18);">交互式客户端：难度依次递减</span></div><div><span style="font-weight: bold;">【1】基于web</span></div><div><span style="font-weight: bold;">【2】基于GUI </span></div><div><span style="font-weight: bold;">【3】基于命令行</span></div><div>③<span style="font-weight: bold; color: rgb(227, 0, 0);">交互式命令行：readline</span></div><div><br/></div><div>224、①<span style="font-weight: bold; color: rgb(222, 87, 0);">相比【服务端】</span>，<span style="font-weight: bold; color: rgb(50, 135, 18);">【客户端】可以使用简单的socket方式，即传统的阻塞式IO</span></div><div>②必须使用同样的协议：</div><div><span style="font-weight: bold; color: rgb(222, 87, 0);">现在【服务端】使用protocolBuffer生成消息</span>，<span style="font-weight: bold; color: rgb(50, 135, 18);">所以【客户端】必须也使用protocolBuffer解析消息</span></div><div><span style="font-weight: bold; color: rgb(227, 0, 0);">③在socket的使用上，客户端在每次发送命令时，都选择重新建立连接，而不是复用之前的连接</span></div><div>④class SocketChannel</div><div><b><font style="color: rgb(156, 0, 76);">socket类的具体使用</font></b></div><div>⑤<span style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="background-color: rgb(255, 255, 255); color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">@Override</span></span></div><div style="font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold;">public</span> <span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">Object send(Object payload) {</span></div><div style="font-size: 9.8pt;"><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; color: rgb(0, 0, 128); font-weight: bold;">    try</span> <span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">(</span><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold; color: rgb(222, 87, 0);">Socket socket = new Socket()</span><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">) {</span></div><div style="font-size: 9.8pt;"><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; color: rgb(0, 0, 0);">    </span><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; color: rgb(0, 0, 0);">    </span><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold; color: rgb(222, 87, 0);">socket.setTcpNoDelay(true);</span></div><div style="font-size: 9.8pt;"><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold; color: rgb(222, 87, 0);">        socket.connect(new InetSocketAddress(this.host, this.port));</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold;">        </span><b><font color="#E30000"><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">this</span><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">.write(socket.getOutputStream(), payload);</span></font></b></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><b><font color="#E30000"><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">        return this</span><span style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">.read(socket.getInputStream());</span></font></b></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">}</span> <span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold;">catch</span> <span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">(IOException e) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold;">    throw new</span> <span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">ChannelException(</span><span style="color: rgb(0, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt; font-weight: bold;">&quot;failed to send and receive&quot;</span><span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">, e);</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">}</span></div><div style="font-size: 9.8pt;"><span style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">}</span></div><div><span style="font-size: unset; color: unset; font-family: unset;">⑥必需的数据+用命令行输入：使用commons-cli</span></div><div><br/></div><div><b><font style="color: rgb(227, 0, 0);">225、客户端支持的命令</font></b></div><div><br/></div><div>226、①interface Command</div><div>②<b><font style="color: rgb(50, 135, 18);">命令上下文：【</font><font style="color: rgb(222, 87, 0);">集群成员列表+KV客户端实际命令</font><font style="color: rgb(50, 135, 18);">】</font></b></div><div>class CommandContext</div><div><span style="color: unset; font-family: unset; font-size: unset;">【1】  </span><span style="color: unset; font-family: unset; font-size: unset;"> 服务器列表：Map&lt;NodeId, Address&gt; serverMap;</span></div><div><span>  </span>  客户端：Client client;</div><div><span>    是否正在运行：</span>running = false;</div><div><span style="font-family: unset; font-size: unset;"><font color="rgba(0, 0, 0, 0)">【2】</font><b><font style="color: rgb(222, 87, 0);">static ServerRouter</font></b><font color="rgba(0, 0, 0, 0)">：</font></span><b style="color: unset; font-family: unset; font-size: unset;"><font style="color: rgb(50, 135, 18);">服务器路由</font></b></div><div>③serverMap.keyset( )：获取所有的key</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;">private</span> ServerRouter buildServerRouter(Map&lt;NodeId, Address&gt; serverMap) {</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span>ServerRouter router = <span style="color: #000080; font-weight: bold;">new</span> ServerRouter();</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>for</span> (NodeId nodeId : serverMap.keySet()) {</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span><span>    </span>Address address = serverMap.get(nodeId);</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span><span>    </span>router.add(nodeId, <span style="color: #000080; font-weight: bold;">new</span> SocketChannel(address.getHost(), address.getPort()));</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;">}</div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-weight: bold;">    </span><font style="color: rgb(222, 87, 0);"><b>return</b> <b>router;</b></font></div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">}</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><br/></div><div>227、①<b><font style="color: rgb(222, 87, 0);">ClientSetLeaderCommand</font></b> implements Command</div><div>②委托client内的ServerRouter来执行setLeaderId</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;">void</span> setClientLeader(NodeId nodeId) {</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #660e7a; font-weight: bold;"><span>    </span>client</span>.getServerRouter().setLeaderId(nodeId);</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">}</div><div>③<b><font style="color: rgb(50, 135, 18);">ServerRouter：路由器类+在客户端内</font></b></div><div>【1】负责处理KV服务端的重定向</div><div>【2】选择leader节点</div><div><br/></div><div>228、<b><font style="color: rgb(50, 135, 18);">①候选服务器：是一个有顺序的服务器id列表，而不是单台服务器的id.</font></b></div><div>②<b><font style="color: rgb(222, 87, 0);">原因：如果集群重新发生了选举</font></b>，手动设置的Leader节点id可能是无效的，需要选择其他节点重试。</div><div>③所以，无论是【手动设置，还是自动检测】到的Leader节点，执行命令时<b><font color="#DE5700">只是候选服务器的【第一个Leader节点】，而不是唯一一个。</font></b></div><div><br/></div><div>229、<font style="color: rgb(50, 135, 18);">①<b><font>重定向请求：由catch (RedirectException e)来实现。</font></b></font></div><div><font>②由于send中只有一个catch，而doSend方法中没有catch<b><font style="color: rgb(222, 87, 0);">，所以只能处理一次重定向</font></b>。</font></div><div>③send方法连续失败，会尝试下一个节点。（因为是for循环<span style="color: unset; font-family: unset; font-size: unset;">）</span></div><div>④如果for循环执行完毕，还没有return，<b><font style="color: rgb(222, 87, 0);">则throw一个没有任何可用服务器的错误</font></b>。</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;">public</span> Object send(Object payload) {</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>for</span> (NodeId nodeId : getCandidateNodeIds()) {</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>try</span> {</div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: rgb(0, 0, 0);">    </span><span style="color: rgb(0, 0, 0);">    </span><b><font color="#328712">Object result = doSend(nodeId, payload);</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#328712"><span>    </span><span>    </span>this.leaderId = nodeId;</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#328712"><span>    </span><span>    </span>return result;</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: rgb(0, 0, 0);">    </span>} <b><font style="color: rgb(222, 87, 0);">catch (RedirectException e) {</font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span style="font-style: italic;"><span>    </span><span>    </span>logger</span>.debug(&quot;not a leader server, redirect to server {}&quot;, e.getLeaderId());</font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span>this.leaderId = e.getLeaderId();</font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700">        return doSend(e.getLeaderId(), payload);</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: rgb(0, 0, 0);">    </span>} <b><font style="color: rgb(227, 0, 0);">catch (Exception e)</font></b> {</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #660e7a; font-style: italic;"><span>    </span><span>    </span>logger</span>.debug(<span style="color: #008000; font-weight: bold;">&quot;failed to process with server &quot;</span> + nodeId + <span style="color: #008000; font-weight: bold;">&quot;, cause &quot;</span> + e.getMessage());</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;">}</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;">}</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>throw new</span> NoAvailableServerException(<span style="color: #008000; font-weight: bold;">&quot;no available server&quot;</span>);</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">}</div><div><br/></div><div>230、①<b><font style="color: rgb(50, 135, 18);">尝试把已设置的leaderd放在候选的最前面</font></b>：再构造一个ArrayList</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;">private</span> Collection&lt;NodeId&gt; getCandidateNodeIds() {</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>if</span> (<span style="color: #660e7a; font-weight: bold;">availableServers</span>.isEmpty()) {</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span><span>    </span>throw new</span> NoAvailableServerException(<span style="color: #008000; font-weight: bold;">&quot;no available server&quot;</span>);</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span>}</div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-weight: bold;">    </span><font color="#DE5700"><b>if</b> <b>(leaderId != null) {</b></font></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span>List&lt;NodeId&gt; nodeIds = new ArrayList&lt;&gt;();</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span>nodeIds.add(leaderId);</font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span>for (NodeId nodeId : availableServers.keySet()) {</font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span><span>    </span>if (!nodeId.equals(leaderId)) {</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span><span>    </span><span>    </span>nodeIds.add(nodeId);</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    <span>    </span></span>}</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span>}</font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span><span>    </span>    </span>return nodeIds;</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700">    }</font></b></div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>return</span> <span style="color: #660e7a; font-weight: bold;">availableServers</span>.keySet();</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;">}</div><div>②<b><font style="color: rgb(227, 0, 0);">增减服务器的命令</font></b>：</div><div><b><font style="color: rgb(222, 87, 0);">增加和删除节点，都只能由leader节点执行，</font><font style="color: rgb(50, 135, 18);">因为客户端只会与leader节点通信。</font></b></div><div>③<b><font style="color: rgb(222, 87, 0);">考虑到增减服务器需要时间</font></b>，<b>如果【在发消息的同时，同时增减服务器】，会导致【实际集群节点列表+客户端节点列表】不一致</b></div><div>④如果 移除的是leader节点。</div><div>不能【在发送消息的同时，同时删除客户端中对应的节点信息】，否则会找不到【现在设置的leader服务器】对应的节点信息。</div><div>⑤<b><font style="color: rgb(227, 0, 0);">内部客户端</font></b></div><div><b><font style="color: rgb(50, 135, 18);">客户端和单个节点之间，用SocketChannel通信，</font></b></div><div><b><font style="color: rgb(50, 135, 18);">在SocketChannel上增加了ServerRouter，用于自动选择leader节点。</font></b></div><div><br/></div><div>231、①class <b><font style="color: rgb(222, 87, 0);">Client</font></b></div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;">public class</span> Client {</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>public static final</span> String <span style="color: #660e7a; font-weight: bold; font-style: italic;">VERSION</span> = <span style="color: #008000; font-weight: bold;">&quot;0.1.0&quot;</span>;</div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-weight: bold;">    </span><font style="color: rgb(222, 87, 0);"><b>private final</b> <b>ServerRouter serverRouter;</b></font></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span>public</span> Client(ServerRouter serverRouter) {</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span><span>    </span>this</span>.<span style="color: #660e7a; font-weight: bold;">serverRouter</span> = serverRouter;</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span>}</div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span style="font-size: 9.8pt;"><span style="color: rgb(0, 0, 128); font-weight: bold;">    </span><b><font color="#DE5700">public void</font></b></span> <b><font color="#DE5700"><span style="font-size: 9.8pt;">addNote(String nodeId, String host,</span> <span style="font-size: 9.8pt;">int</span> <span style="font-size: 9.8pt;">port) {</span><br/></font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span>serverRouter.send(new AddNodeCommand(nodeId, host, port));</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span>}</font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span style="font-size: 9.8pt;"><span>    </span>public void</span> <span style="font-size: 9.8pt;">removeNode(String nodeId) {</span><br/></font></b></div><div style="background-color: rgb(255, 255, 255); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700"><span>    </span><span>    </span>serverRouter.send(new RemoveNodeCommand(nodeId));</font></b></div><div style="font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><b><font color="#DE5700">    }</font></b></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-weight: bold;"><span>    </span>public void</span> <span style="font-size: 9.8pt;">set(String key,</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-weight: bold;">byte</span><span style="font-size: 9.8pt;">[] value) {</span><br/></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #660e7a; font-weight: bold;"><span>    </span><span>    </span>serverRouter</span>.send(<span style="color: #000080; font-weight: bold;">new</span> SetCommand(key, value));</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span>}</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-weight: bold;"><span>    </span>public byte</span><span style="font-size: 9.8pt;">[] get(String key) {</span><br/></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span><span>    </span>return</span> (<span style="color: #000080; font-weight: bold;">byte</span>[]) <span style="color: #660e7a; font-weight: bold;">serverRouter</span>.send(<span style="color: #000080; font-weight: bold;">new</span> GetCommand(key));</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span>}</div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-weight: bold;"><span>    </span>public</span> <span style="font-size: 9.8pt;">ServerRouter getServerRouter() {</span><br/></div><div style="background-color:rgb(255, 255, 255);color:rgb(0, 0, 0);font-family:&quot;JetBrains Mono&quot;, monospace;font-size:9.8pt;"><span style="color: #000080; font-weight: bold;"><span>    </span><span>    </span>return</span> <span style="color: #660e7a; font-weight: bold;">serverRouter</span>;</div><div style="color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-size: 9.8pt;"><span>    </span>}<span style="font-size: 9.8pt; background-color: transparent;">}</span></div><div>②<b><font style="color: rgb(222, 87, 0);">客户端启动</font></b>：-gc A,localhost,3333</div><div><br/></div><div>232、①集群成员列表操作</div><div>②client-add-server</div><div>client-remove-server</div><div><br/></div><div>233、①leader服务器节点：<b><font style="color: rgb(222, 87, 0);">显示+设置</font></b></div><div>②KV服务操作：<b><font style="color: rgb(222, 87, 0);">GET+SET</font></b></div><div><br/></div><div><b><font color="#328712">234-237：单机测试</font></b></div><div><b><font color="#328712"><br/></font></b></div><div><b><font color="#328712">238-267：集群测试</font></b></div><div><br/></div><div>258、<b><font style="color: rgb(222, 87, 0);">本章尝试构造了6个集群测试场景，并分析每个场景下接点输出的日志</font></b></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="34201"/>

<div>
<span><div>0、相关资料：</div><div>1、<span style="color: unset; font-family: unset; font-size: unset;">重点：201、202、【207-211】、@</span><span style="color: unset; font-family: unset; font-size: unset; font-weight: bold;">213</span><span style="color: unset; font-family: unset; font-size: unset;">、【@@</span><span style="color: unset; font-family: unset; font-size: unset; font-weight: bold;">214-220</span><span style="color: unset; font-family: unset; font-size: unset;">】、</span></div><div>2、问题：202、203</div><div><br/></div><div><br/></div><div><br/></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">基于raft算法的KV服务</span></div><div><br/></div><div>189、①<span style="color: rgb(222, 87, 0); font-weight: bold;">由于raft算法本身的复杂性，如果想把单机服务，改造为支持强分布式一致性的服务</span>，</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">②从设计上，很难简单地通过【继承某个超类，或者实现某些特定方法】来完成改造。</span></div><div><span style="font-weight: bold;">③服务本身必须做一些修改，而且服务的执行方式会和【单机服务】有所不同</span></div><div><br/></div><div>190、①<span style="color: rgb(222, 87, 0); font-weight: bold;">与【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">用作缓存的Redis不同</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】，本书设计的KV服务，是基于raft算法的强一致性数据服务</span>。</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">除了【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">写入磁盘</span><span style="color: rgb(50, 135, 18); font-weight: bold;">】，还需要通过raft算法【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">在节点之间同步传输</span><span style="color: rgb(50, 135, 18); font-weight: bold;">】</span>。</div><div>②KV服务受到的请求，会转发到节点的核心组件</div><div>③只读命令也不让follower提供，</div><div><span style="font-weight: bold;">因为follower节点难以保证自己的数据是最新的</span>。</div><div><br/></div><div>191、①follower将请求转发给leader</div><div>【1】follower返回leader的地址，<span style="color: rgb(222, 87, 0); font-weight: bold;">让客户端再发一次。</span></div><div>【2】<span style="color: rgb(222, 87, 0); font-weight: bold;">由follower负责转发给leader</span></div><div>②<span style="color: rgb(50, 135, 18); font-weight: bold;">KV服务只需要做好【服务端逻辑】即可，而相比之下，核心组件【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">既要作为服务端，也要作为客户端</span><span style="color: rgb(50, 135, 18); font-weight: bold;">】。</span></div><div>③GetCommand</div><div>④GetCommandResponse</div><div><br/></div><div>192、①如果KV服务允许返回null，<span style="color: rgb(222, 87, 0); font-weight: bold;">那么客户端需要用found字段，来判断【是否找到数据】</span></div><div>（因为还有可能是接口异常，也返回null）</div><div>②Failure</div><div><br/></div><div>193、①Redirect</div><div>②特殊情况：</div><div>【1】<span style="color: rgb(222, 87, 0); font-weight: bold;">刚启动时，leaderId可能为null</span>，此时follower将读写请求转发给leader时，找不到leader。</div><div>【2】客户端再leaderId为null时，会进行【重试】。       </div><div><br/></div><div>194、①SetCommand</div><div>②<span style="color: rgb(227, 0, 0); font-weight: bold;">请求ID：UUID</span></div><div>请求ID在之后的请求处理流程中，是很重要的字段，<span style="color: rgb(222, 87, 0); font-weight: bold;">用于关联【请求、SET命令、客户端】</span></div><div>③<span style="color: rgb(227, 0, 0); font-weight: bold;">注意：客户端区别于KV服务。</span></div><div><span style="font-weight: bold;">KV服务是在节点处的命令抽象封装，而客户端是在用户那里能用的命令。</span></div><div><br/></div><div>195、①Success</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">基于raft的分布式一致性服务，和一般的单击服务，在执行命令时最大的不同。</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">开始执行到实际操作数据，中间有【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">时间差</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】。</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">②这个时间差是【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">日志同步</span><span style="color: rgb(50, 135, 18); font-weight: bold;">】导致的。</span></div><div>在日志没有被复制到过半节点时，数据不会被操作。</div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">双向调用关系：回调</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">KV组件会调用核心组件，KV组件也需要【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">核心组件的回调数据</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】。</span></div><div><br/></div><div>196、①<span style="color: rgb(50, 135, 18); font-weight: bold;">raft算法本身的限制，KV组件的处理是【异步单线程】</span></div><div>日志在核心组件中追加时，回调数据的操作是按照追加顺序进行的</div><div>②通信部分到KV服务的处理中，<span style="font-weight: bold;">主要关注通过核心组件追加日志时，核心组件是否可以并发处理</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">KV服务层不需要担心【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">核心组件的线程安全</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】</span>，因为核心组件是异步单线程的。</div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">③所以，【</span><span style="color: rgb(227, 0, 0); font-weight: bold;">多个用户</span><span style="color: rgb(227, 0, 0); font-weight: bold;">】可以一起使用KV服务</span></div><div><img src="《分布式算法：raft》_files/Image.png" type="image/png" data-filename="Image.png" width="380"/></div><div><br/></div><div>197、①序列化：protocol的具体代码</div><div>②【序列和反序列化】SetCommand到日志条目</div><div>【1】fromBytes</div><div>【2】toBytes</div><div><br/></div><div>198、①KV服务，<span style="font-weight: bold;">等待核心组件的回调，回调的参数【</span><span style="font-weight: bold;">不会包含与客户端的连接</span><span style="font-weight: bold;">】，</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">②因为连接本身属于重型对象，无法把【连接】序列化到日志条目中。</span></div><div>③解决；在请求中添加一个ID字段，requestId</div><div><br/></div><div>199、①在KV层，生成请求ID，<span style="color: rgb(222, 87, 0); font-weight: bold;">记录请求ID和连接的映射</span></div><div><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">private final</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ConcurrentMap&lt;String, CommandRequest&lt;?&gt;&gt;</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">pendingCommands</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ConcurrentHashMap&lt;&gt;();</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">②核心组件调用KV组件的具体方式：</span><span style="color: rgb(50, 135, 18); font-weight: bold;">StateMachine</span></div><div>【1】<span style="color: rgb(222, 87, 0); font-weight: bold;">KV组件，实现核心组件所要求的的某个接口，然后把自己注册到核心组件中</span></div><div>【2】<span style="color: rgb(50, 135, 18); font-weight: bold;">核心组件调用相应的接口方法，间接调用KV服务</span></div><div>③interface StateMachine</div><div>④class Service implements StateMachine</div><div><br/></div><div>200、①服务实现：<span style="font-weight: bold;">上层服务相关的接口</span></div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">上层服务，拥有raft算法的核心组件（即Node）的实例</span></div><div>③interface Node</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">registerStateMachine在服务启动时调用。</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">上层服务将自己注册到核心组件中</span>，核心组件负责在写入日志到文件之后，回调上层服务</div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public interface</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Node {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">registerStateMachine(</span><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">StateMachine stateMachine);</span></div><div><br/></div><div>201、①interface StateMachine</div><div>②注意getLastApplied方法，本书没有让日志组件管理lastApplied，<span style="color: rgb(227, 0, 0); font-weight: bold;">而是让状态机的实现，即上层服务自身</span>来管理lastApplied。</div><div>③好处：上层服务不需要访问核心组件，也可以知道lastApplied</div><div>④<span style="color: rgb(222, 87, 0); font-weight: bold;">applyLog：日志组件回调上层服务的主要方法</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">上层服务在applyLog方法的实现中，应用命令、修改数据、进行回复客户端等操作。</span></div><div><span style="font-size: 13.0667px;"><span style="font-size: 13.0667px; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">状态机上下文、日志索引、命令的二进制数据、第一条日志的索引</span></span></div><div><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    void</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">applyLog(StateMachineContext context,</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">index,</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">byte</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">[] commandBytes,</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">firstLogIndex);</span></div><div>⑤<span style="color: rgb(227, 0, 0); font-weight: bold;">Service：服务类</span></div><div>持有node类的实例，<span style="color: rgb(50, 135, 18); font-weight: bold;">在node中注册上层服务的StateMachineImpl</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public class</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Service {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    private static final</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Logger</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">logger</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= LoggerFactory.</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic;">getLogger</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(Service.</span><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">class</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    private final</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Node</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">node</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">private final</span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">ConcurrentMap&lt;String, CommandRequest&lt;?&gt;&gt;</span> <span style="font-size: 9.8pt; color: rgb(50, 135, 18); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">pendingCommands</span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">= new ConcurrentHashMap&lt;&gt;();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    private</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Map&lt;String,</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">byte</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">[]&gt;</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">map</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">HashMap&lt;&gt;();</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><br/></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">  </span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;"> public</span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">Service(Node node) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        this.node = node;</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">this.node.registerStateMachine(</span><span style="font-size: 9.8pt; color: rgb(50, 135, 18); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new StateMachineImpl()</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">}</span></div><div><br/></div><div>202、①pendingCommands： 请求ID和连接的映射</div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">因为【网络IO线程】和【核心组件回调时的线程】，会同时访问这个映射</span>，<span style="color: rgb(50, 135, 18); font-weight: bold;">所以映射的类型是ConcurrentHashMap</span></div><div>②<span style="color: rgb(50, 135, 18); font-weight: bold;">CommandRequest&lt;T&gt;是代表连接的类</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">③</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-weight: bold;">addCloseListener</span><span style="color: rgb(222, 87, 0); font-weight: bold;">添加关闭时的监听器【？？？】</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public class</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">CommandRequest&lt;</span><span style="font-size: 9.8pt; color: rgb(32, 153, 157); font-family: &quot;JetBrains Mono&quot;, monospace;">T</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">&gt; {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    private final</span> <span style="font-size: 9.8pt; color: rgb(32, 153, 157); font-family: &quot;JetBrains Mono&quot;, monospace;">T</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">command</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    private final</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Channel</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">channel</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">;</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    public</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">CommandRequest(</span><span style="font-size: 9.8pt; color: rgb(32, 153, 157); font-family: &quot;JetBrains Mono&quot;, monospace;">T</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">command, Channel channel) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        this</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">command</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= command;</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        this</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">channel</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= channel;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">reply(Object response) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        this</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">channel</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.writeAndFlush(response);</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    public void</span> <span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;"><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace; color: rgb(50, 135, 18); font-weight: bold;">addCloseListener</span>(Runnable runnable) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">this</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">.channel.closeFuture().addListener((ChannelFutureListener) future -&gt; runnable.run());</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>203、①<span style="color: rgb(222, 87, 0); font-weight: bold;">以SET命令的实现为例，如何使用 CommandRequest</span></div><div>②checkLeadership：检查当前节点是不是leader</div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">set(CommandRequest&lt;SetCommand&gt; commandRequest) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    SetCommand command = commandRequest.getCommand();</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">    logger</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.debug(</span><span style="font-size: 9.8pt; color: rgb(0, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">&quot;set {}&quot;</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">, command.getKey());</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">  </span> <span style="font-size: 9.8pt; color: rgb(50, 135, 18); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;"> this</span><span style="font-size: 9.8pt; color: rgb(50, 135, 18); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">.pendingCommands.put(command.getRequestId(), commandRequest);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">commandRequest.addCloseListener(() -&gt; pendingCommands.remove(command.getRequestId()));</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    this.node.appendLog(command.toBytes());</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">关闭监听器</span>：</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">主要是考虑到客户端可能设置了超时时间</span>，<span style="color: rgb(50, 135, 18); font-weight: bold;">假如指定超时时间内，日志没有commit，连接就关闭了，那么就无法回复客户端了。</span><span style="color: rgb(227, 0, 0); font-weight: bold;">【？？？】</span></div><div>④测试用GET命令【<span style="color: rgb(227, 0, 0); font-weight: bold;">？？】</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">即使是只读请求</span><span style="color: rgb(222, 87, 0); font-weight: bold;">，也需要经历日志复制的过程，保证节点间的一致性后才能回复结果</span></div><div>⑤（<span style="color: rgb(227, 0, 0); font-weight: bold;">此处为了快速测试，跳过了日志复制，直接返回结果。</span>）</div><div>（<span style="color: rgb(227, 0, 0); font-weight: bold;">注意：如果是生产环境，绝对不能跳过日志复制</span>）</div><div><br/></div><div>204、①状态机实现：StateMachineImpl implements AbstractSingleThreadStateMachine</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">上层服务不需要了解状态机的接口，只需要实现applyCommand即可</span></div><div><br/></div><div>205、①AbstractSingleThreadStateMachine：<span style="font-weight: bold;">实现了管理lastApplied的操作</span></div><div><br/></div><div>206、①<span style="color: rgb(50, 135, 18); font-weight: bold;">多读一写</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">异步单线程</span><span style="color: rgb(50, 135, 18); font-weight: bold;">】处理中，【处理线程+核心组件的线程】都会访问lastApplied，但是只有【处理线程】会修改lastApplied</span></div><div><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">private</span> <span style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">volatile</span></span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">lastApplied</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 255); font-family: &quot;JetBrains Mono&quot;, monospace;">0</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">;</span></div><div>②</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Override</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">applyLog(StateMachineContext context,</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">index,</span> <span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">byte</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">[] commandBytes,</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">firstLogIndex) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">taskExecutor</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">.submit(() -&gt; doApplyLog(context, index, commandBytes, firstLogIndex));</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div>③<span style="color: rgb(222, 87, 0); font-weight: bold;">如果觉得【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">异步单线程</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】有点难理解，可以改成【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">同一线程</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】处理的方式</span></div><div>AbstractDirectStateMachine implements StateMachine</div><div><br/></div><div><span style="font-weight: bold; color: rgb(227, 0, 0);">207-211：通信实现</span></div><div><br/></div><div><span style="font-weight: bold; color: rgb(50, 135, 18);">211：①组件依赖关系</span></div><div><br/></div><div>212、①class Server：</div><div>服务端启动时，只要让<span style="font-weight: bold; color: rgb(222, 87, 0);">负责服务启动的Server</span><span style="font-weight: bold; color: rgb(50, 135, 18);">持有Service的引用，并设置到RPC的处理链（pipeline）中</span></div><div><br/></div><div>213：<span style="color: rgb(222, 87, 0); font-weight: bold;">①Server类：</span><span style="color: rgb(222, 87, 0); font-weight: bold;">负责初始化Service和KV服务的【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">服务端</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】</span>，核心组件Node作为构造函数的参数传入。</div><div>（Node不由Server初始化，因为Node需要的参数太多。）</div><div>②<span style="font-weight: bold; color: rgb(227, 0, 0);">命令行启动：commons-cli</span></div><div><br/></div><div>214-220、<span style="font-weight: bold; color: rgb(222, 87, 0);">命令行解析的例子</span></div><div><br/></div><div>221<span style="font-weight: bold; color: rgb(50, 135, 18);">、raft服务不能单独存在，KV服务启动时，还需要负责</span><span style="font-weight: bold; color: rgb(222, 87, 0);">核心组件的组装和设置</span></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="34175"/>

<div>
<span><div>0、相关资料：<b><font style="color: rgb(227, 0, 0);">netty的NIO编程</font></b>、185、</div><div>1、<span style="font-size: unset; color: unset; font-family: unset;">重点：163、</span><span style="font-size: unset; color: unset; font-family: unset; font-weight: bold;">173</span><span style="font-size: unset; color: unset; font-family: unset;">、182、【186-187】</span></div><div>2、问题：171、<span style="font-weight: bold;">173</span>、174、176</div><div><br/></div><div><br/></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">通信实现</span></div><div><br/></div><div>161、①RequestVote【消息+响应】</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">lastLogIndex</span>：candidate节点最新的日志条目的index</div><div>③<span style="color: rgb(222, 87, 0); font-weight: bold;">响应中没有【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">接受者的字段</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】</span>：</div><div>在raft算法中，<span style="color: rgb(50, 135, 18); font-weight: bold;">通信是按照【一个节点对应一个线程】的同步通信方式进行的</span><span style="font-size: unset; color: unset; font-family: unset;">，所以不需要在响应中包含接受者。</span></div><div>④<span style="color: rgb(50, 135, 18); font-weight: bold;">如果使用NIO，则需要记录远程节点的ID</span></div><div>⑤AppendEntries【消息+响应】</div><div><br/></div><div>162、①AppendEntries【消息+响应】</div><div>【1】<span style="color: rgb(222, 87, 0); font-weight: bold;">prevLogIndex：新增日志的，前一条日志的index</span></div><div>【2】prevLogTerm：新增日志的，前一条日志的term</div><div>【3】leaderCommit：leader节点的commit index</div><div>【4】Entries[ ]：多个日志条目</div><div><br/></div><div>163、①<span style="font-weight: bold;">protocol buffer的定义文件</span>【<span style="color: rgb(50, 135, 18); font-weight: bold;">IDL文件</span>】</div><div><br/></div><div>164、①<span style="color: rgb(50, 135, 18); font-weight: bold;">是否用IDL生成的类作为模型类？【不要用】</span></div><div>②<span style="font-weight: bold;">实际文件位置：</span><span style="color: rgb(227, 0, 0); font-weight: bold;">Protos文件的位置+命令行决定的输出位置</span></div><div><br/></div><div>165、protocol 序列化+反序列化的使用</div><div><br/></div><div>166、①<span style="color: rgb(222, 87, 0); font-weight: bold;">TCP解决重复连接</span>：根据字典排序比较大小+最终只会剩下一个连接</div><div><br/></div><div>167、连接数：最后只需要leader和follower之间的连接</div><div><br/></div><div>168：①应用层，解决半包粘包问题——在发送数据前，加一个长度字段</div><div>②netty的NIO模型</div><div>③interface Connector</div><div><br/></div><div>170、①NIO：线程多路复用：处理超过线程数量的连接</div><div>②netty：pipeline+【图】</div><div><br/></div><div>171、<span style="color: rgb(50, 135, 18); font-weight: bold;">netty解决半包粘包问题：</span></div><div>①LineBaseFrameDecoder：解析<span style="color: rgb(222, 87, 0); font-weight: bold;">基于行</span>的文本协议</div><div>②DelimiterBasedFrameDecoder：解析<span style="color: rgb(222, 87, 0); font-weight: bold;">有指定分隔符</span>的协议</div><div>③LengthFieldBasedFrameDecoder：解析<span style="color: rgb(222, 87, 0); font-weight: bold;">具有长度头</span>的协议</div><div><br/></div><div>173、①如何区分不同类型的信息</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">protocol buffer没有提供从一段二进制数据中，解析不同类型的信息的方法</span></div><div>③在数据长度字段之前，再加一个消息类型字段</div><div><br/></div><div>174<span style="color: rgb(227, 0, 0); font-weight: bold;">、①错误：说是Decoder，方法名却是encode</span></div><div><br/></div><div>175、①out.writeInt(bytes.length)</div><div>②out.writeBytes（bytes）</div><div>③<span style="font-weight: bold;">NodeId没有用protocolbuffer序列化</span>，因为NodeId只是字符串的简单封装</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">④ByteArrayOutputStream作为缓冲</span>：<span style="color: rgb(222, 87, 0); font-weight: bold;">为了确定数据长度</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">private void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">writeMessage(ByteBuf out,</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">messageType, MessageLite message)</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">throws</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">IOException {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">ByteArrayOutputStream byteOutput = new ByteArrayOutputStream();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    message.writeTo(byteOutput);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    out.writeInt(messageType);</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    this</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.writeBytes(out, byteOutput.toByteArray());</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div>⑤writeDelimitedTo</div><div><br/></div><div>176、①<span style="color: rgb(50, 135, 18); font-weight: bold;">这里的in.readBytes是根据payload的大小进行填充吗？</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">byte</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">[] payload =</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new byte</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">[payloadLength];</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">in.readBytes(payload);</span></div><div>②反序列化器有没有办法<span style="color: rgb(222, 87, 0); font-weight: bold;">避免使用缓冲呢？</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">【1】parseDelimitedFrom(InputStream)</span>：protocolbuffer提供了一个从输入流读取【长度+负载】的方法</div><div>【2】上述代码可能无法运行，因为protocolbuffer实际上并不是一个4字节的【长度字段+负载】的类型。</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">除非序列化处理器用了writeDelimitedTo方法，否则反序列化处理器不能使用parseDelimitedFrom</span></div><div><br/></div><div>177、①FromRemoteHandler：区分连接来源节点</div><div>②如果不是，则调用父类的channelRead方法</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Override</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">channelRead(ChannelHandlerContext ctx, Object msg)</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">throws</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Exception {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    if</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(msg</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">instanceof</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NodeId) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        remoteId</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= (NodeId) msg;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">        NioChannel nioChannel =</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NioChannel(ctx.channel());</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        channel</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= nioChannel;</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        channelGroup</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.add(</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">remoteId</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">, nioChannel);</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        return</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">    logger</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.debug(</span><span style="font-size: 9.8pt; color: rgb(0, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">&quot;receive {} from {}&quot;</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">, msg,</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">remoteId</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">super</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">.channelRead(ctx, msg);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="font-size: 9.8pt;"><br/></div><div>178、①AbstractHandler【<span style="color: rgb(222, 87, 0); font-weight: bold;">用eventBus</span>】解决核心组件和RPC组件之间的【<span style="color: rgb(50, 135, 18); font-weight: bold;">双向依赖问题</span>】</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">if</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(msg</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">instanceof</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">RequestVoteRpc) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    RequestVoteRpc rpc = (RequestVoteRpc) msg;</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">eventBus</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">.post</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">(</span><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">RequestVoteRpcMessage(rpc,</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">remoteId</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">,</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">channel</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">));</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">else if</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(msg</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">instanceof</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">RequestVoteResult) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    eventBus</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.post(msg);</span></div><div><br/></div><div>179：①远程节点不按照顺序回复结果时</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">给消息添加【UUID，或顺序的编号】</span>，丢弃编号不一致的结果，<span style="color: rgb(50, 135, 18); font-weight: bold;">依靠raft算法中日志复制的重传</span>，来保证后续处理的正确性。</div><div><br/></div><div>180、①raft算法中的节点：既作为服务端，也作为客户端</div><div><br/></div><div>181、①<span style="font-weight: bold;">ToRemoteHandler：用于连接远程节点的处理器</span></div><div>②sendRequestVote</div><div><br/></div><div>182：①OutboundChannelGroup：管理出口连接的组</div><div>②<b><font style="color: rgb(50, 135, 18);">匿名函数，实现把函数当做参数</font></b></div><div><font color="#000080" face="JetBrains Mono, monospace"><span style="font-size: 13.0667px;"><b>③</b></span></font><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;;"><b>if (future == null)——有两层，实现线程安全</b></span></div><div><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;; font-weight: bold;">《</span><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;; font-weight: bold;">单例模式的双重if判断与线程安全</span><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;; font-weight: bold;">》</span></div><div><span style="color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;;"><b><a href="https://blog.csdn.net/qq_41727218/article/details/88873548">https://blog.csdn.net/qq_41727218/article/details/88873548</a></b></span></div><div><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">private final</span> <span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">ConcurrentMap&lt;NodeId,</span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">Future&lt;NioChannel&gt;</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">&gt;</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">channelMap</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ConcurrentHashMap&lt;&gt;();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">Future&lt;NioChannel&gt; future = channelMap.get(nodeId);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">  </span> <span style="color: rgb(227, 0, 0); font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;"> </span><b><font color="#939600"><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">if</span> <span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">(future ==</span> <span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">null</span></font></b><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;"><font style="color: rgb(147, 150, 0);"><b>)</b></font> {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    </span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    </span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">FutureTask&lt;NioChannel&gt; newFuture = new FutureTask&lt;&gt;(() -&gt; connect(nodeId, address));</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">        future =</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">channelMap</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.putIfAbsent(nodeId, newFuture);</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">   <span>    </span> </span><b><font color="#939600"><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">if</span> <span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">(future ==</span> <span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">null</span></font></b><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;"><font color="#939600"><b>)</b></font> {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">       <span>    </span> future = newFuture;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">        <span>    </span>newFuture.run();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    }</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">try</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">{</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">  </span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;"> return</span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">future.get();</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">catch</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(Exception e) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    channelMap</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.remove(nodeId);</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    if</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(e</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">instanceof</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ExecutionException) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">        Throwable cause = e.getCause();</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    if</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(cause</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">instanceof</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ConnectException) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        throw new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ChannelConnectException(</span><span style="font-size: 9.8pt; color: rgb(0, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">&quot;failed to get channel to node &quot;</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">+ nodeId +</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    &quot;, cause &quot;</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">+ cause.getMessage(), cause);</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    throw new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ChannelException(</span><span style="font-size: 9.8pt; color: rgb(0, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">&quot;failed to get channel to node &quot;</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">+ nodeId, e);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>184、①interface Channel</div><div>②NioChannel implements Channel</div><div><br/></div><div>185、①InboundChannelGroup：负责入口连接</div><div>②不需要按照NodeId查找连接，只需要记录来自远程节点的所有连接。</div><div>③class InboundChannnelGroup：<b><font style="color: rgb(227, 0, 0);">代码本身是参考netty的ChannelGroup编写的</font></b></div><div><b><font color="#E30000"><br/></font></b></div><div><b><font color="#E30000">186、对encoder的测试</font></b></div><div><b><font color="#E30000"><br/></font></b></div><div><b><font color="#E30000">187、对decoder的测试</font></b></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="34173"/>

<div>
<span><div>0、相关资料：</div><div>1、<span style="font-size: unset; color: unset; font-family: unset;">重点：109+119+【</span><span style="font-size: unset; color: unset; font-family: unset;">129-132</span><span style="font-size: unset; color: unset; font-family: unset;">】+133+【</span>136-140<span style="font-size: unset; color: unset; font-family: unset;">】+【</span>142-145<span style="font-size: unset; color: unset; font-family: unset;">】+【</span>146-159<span style="font-size: unset; color: unset; font-family: unset;">】</span></div><div>2、问题：</div><div><br/></div><div><br/></div><div><b><font style="color: rgb(227, 0, 0);">日志实现</font></b></div><div><br/></div><div><br/></div><div>105、日志实现</div><div>①与【只会追加日志的日志系统】不同，在运行中写入的日志，<span style="color: rgb(222, 87, 0); font-weight: bold;">可能会因为冲突，而被丢弃或者说被覆盖。</span></div><div>②二进制存储</div><div>③普通日志条目+【<span style="font-weight: bold;">NO-OP日志条目</span>：选举产生的新leader节点增加的第一条空日志】</div><div>④<span style="color: rgb(222, 87, 0); font-weight: bold;">区分不同日志</span></div><div>【1】设置日志类型：kind</div><div>【2】<span style="color: rgb(50, 135, 18); font-weight: bold;">给日志条目增加类型字段</span></div><div>⑤interface entry</div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">EntryMeta getMeta();——</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">返回除了【</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">负载</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">】之外的日志元信息</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">byte</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">[] getCommandBytes();</span></div><div><br/></div><div>106、①GeneralEntry</div><div><br/></div><div>107、①AbstractEntry</div><div>②NoOpEntry</div><div><br/></div><div>108、①存储介质</div><div>【1】本地文件：RandomAccessFile</div><div>【2】内嵌KV数据库</div><div>【3】内嵌RDBMS数据库：mysql</div><div><br/></div><div>109、①<span style="color: rgb(227, 0, 0); font-weight: bold;">日志接口功能列表</span></div><div>②interface log</div><div><br/></div><div>110、①<span style="color: rgb(222, 87, 0); font-weight: bold;">日志序列化从日志中拆出来，方便后面添加【日志快照】</span></div><div>②interface EntrySequence</div><div><br/></div><div>111、①AbstractEntrySequence</div><div><br/></div><div>112、①<span style="color: rgb(222, 87, 0); font-weight: bold;">日志偏移索引：这条日志的位置</span></div><div>②<span style="color: rgb(50, 135, 18); font-weight: bold;">当日志偏移索引【等于】下一条日志的索引时</span>，当前日志条目序列为空</div><div>③AbstractEntrySequence</div><div><br/></div><div>113、<span style="color: rgb(227, 0, 0); font-weight: bold;">①随机获取：获取指定位置的数据</span></div><div>②获取指定索引的日志条目：<span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">protected abstract</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Entry doGetEntry(</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">index);</span></div><div><br/></div><div><br/></div><div>114、①获取一个子视图：<span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">protected abstract</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">List&lt;Entry&gt; doSubList(</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">fromIndex,</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">toIndex);</span></div><div><br/></div><div>115、①追加日志：<span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">protected abstract void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">doAppend(Entry entry);</span></div><div>②移除指定索引后的日志条目：<span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">protected abstract void</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">doRemoveAfter(</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">int</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">index);</span></div><div>③MemoryEntrySequence：基于内存</div><div><br/></div><div>116、①追加日志条目</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Override</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">protected void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">doAppend(Entry entry) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    entries</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.add(entry);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>117、①FileEntrySequence</div><div>【1】日志条目文件：Entries</div><div>【2】日志条目索引文件：EntryIndexFile</div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">【3】</span><span style="color: rgb(227, 0, 0); font-weight: bold;">等待写入的日志条目缓冲：pendEntries，类型为LinkedList&lt;Entry&gt;</span></div><div><br/></div><div>119、①interface SeekableFile：</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">把用到的RandomAccessFile方法抽象出来</span>，设计了一个叫做SeekableFile的接口</div><div>②<span style="color: rgb(50, 135, 18); font-weight: bold;">RandomAccessFileAdapter implements SeekableFile</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">基于RandomAccessFile的实现</span></div><div><br/></div><div>121、①<span style="color: rgb(50, 135, 18); font-weight: bold;">EntriesFile</span>：使用SeekableFile</div><div><br/></div><div>123、①EntryFactory：创建Entry</div><div>②EntryIndexFile implements <span style="color: rgb(227, 0, 0); font-weight: bold;">Iterable&lt;EntryIndexItem&gt;</span></div><div>③<span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">private</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Map&lt;Integer, EntryIndexItem&gt;</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">entryIndexMap</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">HashMap&lt;&gt;();</span></div><div><br/></div><div>124、①<span style="color: rgb(50, 135, 18); font-weight: bold;">这里用了SeekableFile的游标机制，所以两次读会获得不同的值</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    minEntryIndex</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">seekableFile</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.readInt();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    maxEntryIndex</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">seekableFile</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.readInt();</span></div><div>②EntryIndexItem：日志条目元信息</div><div><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    entryIndexMap</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.put(index,</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">EntryIndexItem(index, offset, kind, term));</span></div><div><br/></div><div>127、FileEntrySequence</div><div><br/></div><div>128、①<span style="color: rgb(222, 87, 0); font-weight: bold;">interface Log：获取指定文件地址的接口——用java.io.File实现</span></div><div><br/></div><div>129-132：都要考虑【<span style="color: rgb(50, 135, 18); font-weight: bold;">日志缓冲+根据日志条目索引来获得的日志条目文件</span>】</div><div><br/></div><div>133、①<span style="color: rgb(227, 0, 0); font-weight: bold;">对接：日志条目序列+日志接口</span></div><div>②AbstractLog implements Log</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Override</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">EntryMeta getLastEntryMeta() {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    if</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">entrySequence</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.isEmpty()) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    return new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">EntryMeta(Entry.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">KIND_NO_OP</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">,</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">snapshot</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.getLastIncludedIndex(),</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">snapshot</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.getLastIncludedTerm());</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    return</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">entrySequence</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.getLastEntry().getMeta();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>135、①EntrySequenceView：<span style="color: rgb(50, 135, 18); font-weight: bold;">可以直接传入日志条目</span>的索引操作</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">EntrySequenceView(List&lt;Entry&gt; entries) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    this</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">entries</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= entries;</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    if</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(!entries.isEmpty()) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        firstLogIndex</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= entries.get(</span><span style="font-size: 9.8pt; color: rgb(0, 0, 255); font-family: &quot;JetBrains Mono&quot;, monospace;">0</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">).getIndex();</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        lastLogIndex</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= entries.get(entries.size() -</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 255); font-family: &quot;JetBrains Mono&quot;, monospace;">1</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">).getIndex();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    }</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>136-140：<span style="color: rgb(227, 0, 0); font-weight: bold;">对接：日志条目序列+日志接口</span></div><div><br/></div><div>141：①FileLog：根据baseDir获得文件</div><div>②<span style="color: rgb(50, 135, 18); font-weight: bold;">多个日志的分代（generation）</span><span style="color: rgb(227, 0, 0); font-weight: bold;">【有图】</span></div><div>③日志代目录里</div><div>entries.bin对应EntriesFile，entries.idx对应EntryIndexFile</div><div><br/></div><div>142-145、与选举部分对接</div><div><br/></div><div>146-159：测试</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="33971"/>

<div>
<span><div>0、相关资料：</div><div>1、<span style="font-size: unset; color: unset; font-family: unset;">重点：61+97+【98-103】测试代码</span></div><div>2、问题：73+75+82</div><div><br/></div><div><br/></div><div><font style="color: rgb(227, 0, 0);"><b>选举实现</b></font></div><div><br/></div><div>59、角色建模</div><div>①<span style="color: rgb(50, 135, 18); font-weight: bold;">角色与数据【表格】@@</span></div><div>②class AbstractNodeRole</div><div><br/></div><div>60、①enum RoleName</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">避免了用instanceof判断对象，而是内置了一个【角色的字段】</span></div><div>②class FollowerNodeRole</div><div><br/></div><div>61、①角色对应的类的字段，都是不可变的。</div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">follower选举超时，或者接收到来自leader节点服务器的心跳信息时，必须新建一个角色实例。</span></div><div>②class CandidateNodeRole</div><div><br/></div><div>62、<span style="color: rgb(50, 135, 18); font-weight: bold;">①构造函数：可以指定票数</span>——<span style="color: rgb(227, 0, 0); font-weight: bold;">新建对象</span></div><div>②increaseVotesCount：return new CandidateNodeRole( term, votesCount+1, electionTimeout) </div><div>③class LeaderNodeRole</div><div><br/></div><div>63、状态机模式-问题</div><div>①问题：</div><div>【1】<span style="color: rgb(222, 87, 0); font-weight: bold;">角色变更-涉及其他角色太多——比如日志、集群成员表</span></div><div>【2】父类抽象化大部分处理逻辑，子类个性化的场景很少</div><div>②解决</div><div>【1】<span style="color: rgb(50, 135, 18); font-weight: bold;">传入stateMachineContext之类的上下文，间接访问其他状态数据</span></div><div>【2】角色数量太少，只有3个，状态机优势不明显，所以没用角色状态机</div><div>③定时器组件</div><div><br/></div><div>64、①<span style="color: rgb(50, 135, 18); font-weight: bold;">Executors：newSingleThreadScheduledExecutor()</span></div><div>创建一个单线程执行器，可以调度命令在给定的延迟之后运行，或定期执行。</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">此定时器自带一个执行线程，不会出现两个定时器同时执行的情况</span></div><div>②interface Scheduler</div><div><br/></div><div>65、①设置定时器线程名为“schduler”，<span style="color: rgb(50, 135, 18); font-weight: bold;">后面的参数类型为ThreadFactory</span></div><div><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">scheduledExecutorService</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= Executors.</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic;">newSingleThreadScheduledExecutor</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">(r -&gt;</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Thread(r,</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">&quot;scheduler&quot;</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">));</span></div><div>②scheduleElectionTimeout</div><div><br/></div><div>66、①重载了tostring方法，根据不同状态，显示不同字符串</div><div>②传入接口，可以有【多种实现类】</div><div><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;"><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public</span> ElectionTimeout(ScheduledFuture&lt;?&gt; scheduledFuture) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">this</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">scheduledFuture</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= scheduledFuture;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div>③scheduledExecutorService.schedule</div><div><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">scheduledExecutorService.scheduleWithFixedDelay</span></div><div><br/></div><div>67、①class RequestVoteRPC</div><div><br/></div><div>68、RequestVoteResult</div><div><br/></div><div>69、①AppendEntriesRpc</div><div>②用list对象，而不是数组。</div><div>③AppendEntriesResult</div><div><br/></div><div>70、关联组件和工具</div><div>①<span style="color: rgb(222, 87, 0); font-weight: bold;">间接层：访问这个类，间接访问其他组件的引用</span>。【<span style="color: rgb(50, 135, 18); font-weight: bold;">而不是直接持有其他对象的引用</span>】</div><div>②核心组件：Node+NodeImplement</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">间接层：NodeContext</span></div><div><br/></div><div>71、<span style="color: rgb(222, 87, 0); font-weight: bold;">RPC接口：interface Connector</span></div><div><br/></div><div>72、①<span style="color: rgb(222, 87, 0); font-weight: bold;">任务执行接口：interface TaskExector</span></div><div>②使用例子：<span style="color: rgb(50, 135, 18); font-weight: bold;">context.taskExector().submit( ()-&gt;{  //处理逻辑</span></div><div>        }</div><div>)</div><div>③<span style="font-weight: bold;">异步单线程实现：SingleThreadTaskExecutor</span> implements TaskExecutor</div><div>构造函数的不同</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">【1】传入名称</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">【2】接受一个线程工厂</span></div><div><br/></div><div>73、①<span style="color: rgb(50, 135, 18); font-weight: bold;">FutureTask&lt;?&gt; futureTask</span> = new FutureTask&lt;&gt;(task,null)</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">DirectTaskExecutor：不新建线程，就只是执行</span></div><div>异步单线程的实现，直接执行的版本</div><div><br/></div><div>74、①interface NodeStore</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">用于存储【节点重启“需要恢复”的数据】：votedFor ,currentTerm</span>——<span style="color: rgb(50, 135, 18); font-weight: bold;">其他数据都可以从其他节点得到</span></div><div>③MemoryNodeStore</div><div><br/></div><div>75、<span style="color: rgb(50, 135, 18); font-weight: bold;">FileNodeStore：文件存储</span></div><div><br/></div><div>78、①一致性组件：也叫核心组件</div><div>②NodeImpl的字段只是用final表示不可变，<span style="color: rgb(222, 87, 0); font-weight: bold;">没有使用volatile处理多线程访问</span>。</div><div>因为前面的线程模型提到，<span style="color: rgb(50, 135, 18); font-weight: bold;">处理组件是【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">异步单线程</span><span style="color: rgb(50, 135, 18); font-weight: bold;">】，内部的字段经过【</span><span style="color: rgb(50, 135, 18); font-weight: bold;">线程封闭</span><span style="color: rgb(50, 135, 18); font-weight: bold;">】</span>，保证不会出现多线程安全问题</div><div><br/></div><div>79、①<span style="color: rgb(222, 87, 0); font-weight: bold;">synchronized</span> void start()：<span style="color: rgb(50, 135, 18); font-weight: bold;">同步方法</span>，防止同时调用</div><div>②设置选举超时：<span style="color: rgb(227, 0, 0); font-weight: bold;">this::electionTimeout</span>——<span style="color: rgb(50, 135, 18); font-weight: bold;">匿名表达式，调用当前实例的electionTimeout方法。</span></div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">changeToRole</span></div><div>统一角色变化的代码+【<span style="font-weight: bold;">把角色变化同步到NodeStore</span>】</div><div><br/></div><div>80、<span style="color: rgb(222, 87, 0); font-weight: bold;">synchronized</span> void stop()</div><div>设置一个变量，如果没有开始，则不能调用这个方法</div><div><br/></div><div>81、①选举超时：electionTimeout</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">默认是在定时器的线程中，为了在主线程执行</span>，<span style="color: rgb(50, 135, 18); font-weight: bold;">需要做一个任务转换</span></div><div>②listEndpointExceptSelf（）：返回除当前节点外的其他节点</div><div>③NodeGroup</div><div><br/></div><div>82、①收到RequestVote消息</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Subscribe</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">onReceiveRequestVoteRpc(RequestVoteRpcMessage rpcMessage) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    context</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.taskExecutor().submit(</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    </span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">() -&gt;</span> <span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">context.connector().replyRequestVote</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">(</span><span style="font-size: 9.8pt; color: rgb(50, 135, 18); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">doProcessRequestVoteRpc(rpcMessage), rpcMessage)</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">,</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">    LOGGING_FUTURE_CALLBACK</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    );</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div>②<span style="color: rgb(227, 0, 0); font-weight: bold;">用@subscribe获得信息，并提交给taskExecutor线程来处理</span></div><div><br/></div><div>84、</div><div>①becomeFollower：<span style="color: rgb(222, 87, 0); font-weight: bold;">有一个是否设置选举超时的参数</span></div><div>②在之后在【<span style="color: rgb(50, 135, 18); font-weight: bold;">服务器变更</span>】中移除服务器节点时，会设计【<span style="color: rgb(50, 135, 18); font-weight: bold;">不需要设置选举超时的场景</span>】。</div><div><br/></div><div>85、①收到RequestVote响应</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Subscribe</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">onReceiveRequestVoteResult(RequestVoteResult result) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">        context</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.taskExecutor().submit(() -&gt; doProcessRequestVoteResult(</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace;">result</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">),</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">LOGGING_FUTURE_CALLBACK</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>86、①<span style="color: rgb(222, 87, 0); font-weight: bold;">响应中的term与本地一致</span>，并且收到投票后，进入下一阶段</div><div><br/></div><div>87、①设置自己为leader角色，<span style="color: rgb(222, 87, 0); font-weight: bold;">启动日志复制定时器，添加一条NO-OP日志</span>。（<span style="color: rgb(50, 135, 18); font-weight: bold;">这个在之前有解释</span>）</div><div>②重置选举：cancelTimeoutOrTask</div><div>③发送心跳信息：</div><div><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">void</span> replicateLog() {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    context</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">.taskExecutor().submit</span><span style="font-size: 9.8pt; color: rgb(222, 87, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">(this::doReplicateLog</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">,</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">LOGGING_FUTURE_CALLBACK</span><span style="font-size: 9.8pt; font-family: &quot;JetBrains Mono&quot;, monospace;">);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>88、①两个同名方法：区别——<span style="color: rgb(222, 87, 0); font-weight: bold;">参数不同</span>——<span style="color: rgb(50, 135, 18); font-weight: bold;">操作列表+操作单个元素</span></div><div>②收到来自leader节点的心跳消息</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Subscribe</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">onReceiveAppendEntriesRpc(AppendEntriesRpcMessage rpcMessage) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    context</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.taskExecutor().submit(() -&gt;</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    context</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.connector().replyAppendEntries(doProcessAppendEntriesRpc(</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace;">rpcMessage</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">),</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace;">rpcMessage</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">),</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">    LOGGING_FUTURE_CALLBACK</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    );</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>89、①becomeFollower</div><div><br/></div><div>90、①<span style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Subscribe</span></span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">onReceiveAppendEntriesResult(AppendEntriesResultMessage resultMessage) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">context</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.taskExecutor().submit(() -&gt; doProcessAppendEntriesResult(</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace;">resultMessage</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">),</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">LOGGING_FUTURE_CALLBACK</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>91、①组件的mock化</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">mock测试</span>：不容易构造的对象 ，创建一个虚拟的对象，以方便测试</div><div>②测试专用定时器组件：NullScheduler</div><div>③测试专用RPC组件：MockConnector</div><div>④快速构造NodeImpl：NodeBuilder</div><div>⑤<span style="color: rgb(222, 87, 0); font-weight: bold;">return LogReplicationTask.NONE；</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">return ElectionTimeout.NONE</span></div><div><br/></div><div>92、①<span style="color: rgb(222, 87, 0); font-weight: bold;">创建NONE实例</span></div><div><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public static final</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ElectionTimeout</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">NONE</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">=</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ElectionTimeout(</span><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NullScheduledFuture());</span></div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">对ScheduledFuture的封装</span>，</div><div><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public class</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NullScheduledFuture</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">implements</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">ScheduledFuture&lt;Object&gt;</span></div><div><br/></div><div>93、①MockConnector implements Connector</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">内部类 Message</span>：</div><div><span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public static class</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Message {</span></div><div><br/></div><div>94、①发送消息的逻辑</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Override</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">sendAppendEntries(</span><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">AppendEntriesRpc rpc,</span> <span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NodeEndpoint destinationEndpoint) {</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    Message m =</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Message();</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    m.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">rpc</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= rpc;</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    m.</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">destinationNodeId</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">= destinationEndpoint.getId();</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    messages</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.add(m);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>95、①想要暴露NodeImpl内部数据，<span style="color: rgb(50, 135, 18); font-weight: bold;">可以增加一个package级别的可见性方法</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">即不写public、private、protected修饰符</span></div><div>②NodeImpl implements Node</div><div><br/></div><div>96、①class NodeBuilder</div><div><br/></div><div>97、①构建上下文：private <span style="color: rgb(222, 87, 0); font-weight: bold;">NodeContext buildContext</span>（）</div><div>②构建Node实例：</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Node build() {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    return new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NodeImpl(buildContext());</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div>③<span style="color: rgb(222, 87, 0); font-weight: bold;">NodeImplTest</span></div><div>④<span style="color: rgb(50, 135, 18); font-weight: bold;">P96-97——链式调用的例子</span></div><div><br/></div><div>98、</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="33853"/>

<div>
<span><div>0、相关资料：3、4、29</div><div>1、<span style="font-size: unset; color: unset; font-family: unset;">重点：18、20+23+24+45+48</span></div><div>2、问题：25+29+39+47</div><div><br/></div><div><br/></div><div><b><font style="color: rgb(50, 135, 18);">【P23-24】空操作日志的作用：</font></b></div><div><b><font style="color: rgb(50, 135, 18);"><span>    【1】</span>让【大部分的】都获得【新的term】</font></b></div><div><b><font><font color="#328712">    【2】本质原因：commit之前的日志+新增当前的epoch，</font><font color="#E30000">两个操作不是【</font></font></b><span style="font-weight: bold;"><font color="#E30000">原子性</font></span><b><font><font color="#E30000">】的。</font><br/></font></b></div><div><br/></div><div><br/></div><div>2、共识算法</div><div>3、</div><div>①<span style="color: rgb(227, 0, 0); font-weight: bold;">@@paxos算法的修改版</span></div><div>②paxos算法的结构</div><div>③multi Paxos</div><div>4、</div><div>①<span style="color: rgb(227, 0, 0); font-weight: bold;">@@paxos的变种算法</span></div><div>②<span style="color: rgb(227, 0, 0); font-weight: bold;">@@</span><span style="color: rgb(227, 0, 0); font-weight: bold;">raft官网raft.github.io+raft算法实验性的实现</span></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">@@thesecretlivesofdata.com：leader选举和日志复制的可视化过程+raft相关的论文、演讲和教程连接</span></div><div>5、</div><div>①基于GO语言的etcd：生产环境级别的raft算法</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">就算理解了ZAB算法，也不一定能完全理解zookeeper的设计</span></div><div><br/></div><div>8、</div><div>①<span style="color: rgb(50, 135, 18); font-weight: bold;">日志状态机模型</span>：日志写入，而不是直接修改。</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">能够根据日志，重新计算出当前状态</span></div><div>②形式代换：分布式一致性问题——变为如何保证所有节点按照同一顺序写入</div><div><br/></div><div>9、<span style="font-size: unset; color: unset; font-family: unset;">①Quorum：</span><b style="font-size: unset;"><span style="font-size: unset; font-weight: bold; color: rgb(50, 135, 18); font-family: unset;">过半写入+大部分读</span></b></div><div><br/></div><div>10、<span style="font-size: unset; color: unset; font-family: unset;">①无重复投票</span></div><div><br/></div><div>12、leader节点投票的例子</div><div>①为什么不是3*3*3=27种结果，而是10种结果？</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">因为有比较大小关系，如果A给B投票了，B就不能给A投票了</span></div><div><br/></div><div>13、<span style="font-size: unset; color: unset; font-family: unset;">①AppendEntries：</span><span style="font-size: unset; color: unset; font-family: unset; font-weight: bold;">日志复制</span><span style="font-size: unset; color: unset; font-family: unset;">。</span></div><div>增加日志条数为0时，也作为<span style="font-weight: bold;">心跳消息</span>。</div><div>②逻辑时钟term</div><div><br/></div><div>14、①<span style="color: rgb(50, 135, 18); font-weight: bold;">Lamport Timestamp：</span>多个进程要维护一个【全局时间】</div><div>【1】事件发生时，递增自己本地的时间副本，+1</div><div>【2】发送消息时，携带自己的时间副本</div><div>【3】接收消息时，选择比较大的时间值，并+1</div><div>②<span style="color: rgb(50, 135, 18); font-weight: bold;">Raft算法</span></div><div>【1】<span style="color: rgb(222, 87, 0); font-weight: bold;">开始选举时，term+1</span></div><div>【2】发送消息时，发送RequestVote，戴上自己的term</div><div>【3】接收消息时，跟本地的比较，选择比较大的（<span style="color: rgb(222, 87, 0); font-weight: bold;">此处不+1</span>）</div><div>③<span style="color: rgb(222, 87, 0); font-weight: bold;">递增——避免给比较早的term投票</span></div><div>比如因为【慢速网络+网络分区】，而迟到的投票请求</div><div><br/></div><div>15、①心跳超时——follower变为candidate</div><div>②票数相同——<span style="color: rgb(222, 87, 0); font-weight: bold;">随机选举超时</span></div><div>③<span style="font-weight: bold;">candidate和leader收到更大的term，会退化为follower</span></div><div><br/></div><div>16、①心跳信息间隔【&lt;&lt;远小于】最小选举间隔</div><div>随机选举超时——<span style="color: rgb(222, 87, 0); font-weight: bold;">即为最小选举间隔的【随机】</span></div><div><br/></div><div>18、①<span style="font-weight: bold;">commitIndex</span>：节点维护的，已持久化的日志条目索引</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">leader负责记录各个节点</span>：</div><div>【1】<span style="font-weight: bold;">nextIndex</span>：写一个需要复制日志条目的索引</div><div>【2】<b><font style="color: rgb(227, 0, 0);">matchIndex：已匹配日志的索引【结合P21】</font></b></div><div>③raft复制过程：<span style="color: rgb(50, 135, 18); font-weight: bold;">乐观策略——把nextIndex设为最大值，不匹配则回退</span></div><div><br/></div><div>19、raft日志复制流程</div><div><br/></div><div>20、①Appendentries消息：还包含leader节点最新的commitIndex</div><div>②<span style="color: rgb(227, 0, 0); font-weight: bold;">在leader节点推进commitIndex的同时，【</span><span style="color: rgb(227, 0, 0); font-weight: bold;">状态机执行日志中的命令，并把计算后的结果返回给客户端</span><span style="color: rgb(227, 0, 0); font-weight: bold;">】</span></div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">【日志持久化】和【状态机应用日志】</span>，可以同时进行。</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">推进commitIndex后，表示状态机应用哪条日志的lastApplied也可以同时推进。</span></div><div>④最下面的案例：是“不遵循过半写入的反面案例”</div><div><br/></div><div>21、①raft算法中，节点启动时，<span style="color: rgb(222, 87, 0); font-weight: bold;">commitIndex一开始为0，而不是节点日志中最后一条日志的索引</span></div><div>②<span style="font-weight: bold;">原因：leader可能在过半复制完成前宕机。</span></div><div><span style="font-weight: bold;">而原leader节点重启后，不可人为自己日志中最后一条日志条目是有效的。</span></div><div><br/></div><div>22、</div><div>①以leader节点为准。<span style="color: rgb(50, 135, 18); font-weight: bold;">follower中不同的日志条目，会被leader中的日志覆盖</span>。</div><div>②matchIndex：</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">lastLogIndex</span><span style="font-weight: bold;">：各节点最后一条日志的索引。（可能还没commit）</span></div><div>③leader节点的commitIndex：</div><div>由follower节点的复制进度决定</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">④有关于不同term的具体例子：【反复宕机】</span></div><div>“1,2”：表示这个节点有term为1和2的日志条目</div><div><br/></div><div>23、①（<span style="color: rgb(50, 135, 18); font-weight: bold;">承接P22）</span><span style="color: rgb(222, 87, 0); font-weight: bold;">已经过半写入的日志条目，也不能确定在接下来的日志复制中不会被覆盖。</span></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">这个现象导致，commitIndex不能简单地用【</span><span style="color: rgb(227, 0, 0); font-weight: bold;">过半matchIndex</span><span style="color: rgb(227, 0, 0); font-weight: bold;">】来计算，还需要看【</span><span style="color: rgb(227, 0, 0); font-weight: bold;">过半matchIndex的term</span><span style="color: rgb(227, 0, 0); font-weight: bold;">】</span></div><div>②<span style="color: rgb(227, 0, 0); font-weight: bold;">解决：对于leader节点，只有日志条目的term和自己的term一致，才可以更新commitIndex</span>。</div><div>③<span style="font-weight: bold;">另一个细节：新leader节点选举出来之后，如果没有来自客户端的更新请求，commitIndex就永远不会更新。</span></div><div>【1】因为新leader节点的term，肯定比之前leader节点复制过来的最后日志的term大</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">【2】解决：新leader节点选出后，将当前term的一个空操作日志加入term</span></div><div>④<span style="color: rgb(50, 135, 18); font-weight: bold;">本质：如果日志没有过半，不会被选举为leader。</span></div><div><br/></div><div>24、<span style="color: rgb(227, 0, 0); font-weight: bold;">角色变化表</span></div><div>①<span style="color: rgb(222, 87, 0); font-weight: bold;">RequestVote.term=currentTerm，三个都不投票——已经投过票了，或者自己就是candidate</span></div><div>②AppendEntries.term=currentTerm：<span style="color: rgb(222, 87, 0); font-weight: bold;">candidate——变成follower，追加日志</span></div><div><br/></div><div>25、响应部分：</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">除了自己的角色发出去的消息外，这里一律采用忽略的策略</span></div><div><br/></div><div>26、设计思路</div><div>①比较难以理解，或者说比较同意忽视的，commitIndex更新条件的分析</div><div>②</div><div>【1】为什么这么设计</div><div>【2】<span style="color: rgb(50, 135, 18); font-weight: bold;">不这么设计会有什么后果，否则会在特定场合出现奇怪的问题</span></div><div><br/></div><div>27、<span style="color: rgb(50, 135, 18); font-weight: bold;">①生产环境使用raft算法，比如实现各种中间件</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">②分析状态数据、组件关系、线程模型</span></div><div><br/></div><div>28、①<span style="color: rgb(227, 0, 0); font-weight: bold;">任何可以【用状态机表示的服务】，理论上都可以基于raft算法实现一个分布式的版本</span></div><div>②<span style="font-weight: bold;">日志、通信，相对通信，但又需要满足raft算法特性的组件</span></div><div>分布式算法一般会内置几个事先设计好的、替换的组件实现，比如zookeeper</div><div>③<span style="color: rgb(222, 87, 0); font-weight: bold;">不建议过早优化性能。</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">比如异步编码，比如多线程</span></div><div>④TPS：一秒能处理的请求</div><div><br/></div><div>29、①及群成员管理：单服务器变更</div><div>②<span style="color: rgb(227, 0, 0); font-weight: bold;">Logcabin，GO语言写的etcd，用Rust写的tikv，用C++写的braft，</span></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">支付宝公开了参考braft实现的soft-jraft</span></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">用Java编写的atomix，文档丰富，API易懂</span></div><div><br/></div><div>30、①currentTerm：当前选举的term</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">leader维护的——nextIndex[ ]</span>：follower服务器下一个要复制的日志索引。</div><div>因为有多个follower，所以为数组</div><div>③leader维护的——matchIndex[ ]：相匹配的日志索引</div><div><br/></div><div>31、①服务器ID：<span style="color: rgb(222, 87, 0); font-weight: bold;">如果用整数</span>，增加或减少的时候，会导致<span style="color: rgb(222, 87, 0); font-weight: bold;">服务器ID不连续</span></div><div>②解决</div><div><span style="font-weight: bold;">【1】遍历的时候：判断follower是否已被移除</span></div><div><span style="font-weight: bold;">【2】hashMap映射表——</span><span style="color: rgb(222, 87, 0); font-weight: bold;">class </span><span style="color: rgb(222, 87, 0); font-weight: bold;">NodeId</span></div><div><br/></div><div>32、<span style="color: rgb(222, 87, 0); font-weight: bold;">class </span><span style="color: rgb(222, 87, 0); font-weight: bold;">NodeId</span></div><div>①只是一个【字符串的封装】</div><div>②of方法：快速创建当前类的对象</div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public static</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NodeId of(</span><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Nonnull</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">String value) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    return new</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">NodeId(value);</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div>③静态数据：很少需要改变的数据</div><div><br/></div><div>33、①minElectionTimeout，maxElectionTimeout，logReplicationInterval</div><div>②可以先不用从【环境变量，配置文件】中读取，而使用【固定配置】</div><div>③<span style="color: rgb(222, 87, 0); font-weight: bold;">集群成员列表：在日志中放差分数据——需要使用时，计算得出</span></div><div>④</div><div>【1】持久化</div><div>【2】初始数据+日志中存差分数据</div><div>【3】日志中存【每次存上一次的数据+差分数据】</div><div><br/></div><div>34、①方案2的缺点：初始数据，在配置文件中，修改可能会出错</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">方案3的缺点：可能无法强制集群以新的成员列表启动——需要手动增减服务器</span></div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">对②的解决：忽略日志，并以修改后的初始配置直接启动集群的模式</span></div><div>④根据ID查集群成员——map——class NodeGroup</div><div><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    private</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Map&lt;NodeId, GroupMember&gt;</span> <span style="background-color: rgb(255, 255, 255); font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">memberMap</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">;</span></div><div><br/></div><div>35、①getMember：不检查成员是否存在，直接返回</div><div>findMember：没有时，抛出异常</div><div>②上面2个的<span style="color: rgb(222, 87, 0); font-weight: bold;">区别：使用时，是否能容忍null</span></div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">返回除自己之外的其他节点：stream().filter()</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">Collection&lt;GroupMember&gt; listReplicationTarget() {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    return</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">memberMap</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.values().stream().filter(m -&gt; !m.idEquals(</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">selfId</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">)).collect(Collectors.</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic;">toList</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">());</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>36、<span style="color: rgb(222, 87, 0); font-weight: bold;">class GroupMember：集群成员信息</span></div><div>①NodeEndpoint：IP+端口</div><div>②ReplicationState：复制进度——nextIndex，matchIndex</div><div><br/></div><div>37、①ensureReplicatingState：保证复制进度存在</div><div>②NodeEndpoint：IP+端口</div><div><br/></div><div>38、①日志组件：拥有commitIndex</div><div>一致性算法组件：核心组件</div><div>②<span style="color: rgb(50, 135, 18); font-weight: bold;">分离数据：提供并行的可能性</span></div><div><br/></div><div>39、①调用顺序+依赖关系：</div><div>定时器+一致性算法组件，一致性算法组件+【成员表组件，日志组件】</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">解耦组件间的【双向调用关系】</span></div><div>解决：</div><div>【1】合并一致性算法组件+通信组件：代码容易膨胀</div><div>【2】<span style="color: rgb(222, 87, 0); font-weight: bold;">回调：一致性算法组件，持有一个rpc对象引用</span></div><div>【3】延迟设置：类A和类B相互依赖——<span style="color: rgb(222, 87, 0); font-weight: bold;">不通过构造函数，而是通过setter</span></div><div>【4】<span style="color: rgb(50, 135, 18); font-weight: bold;">Pub-Sub：发布订阅模式——消息中间件</span></div><div>【5】akka的actor模型？？？</div><div><br/></div><div><br/></div><div>41、使用了<span style="color: rgb(222, 87, 0); font-weight: bold;">Guava的EventBus</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(128, 128, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">@Subscribe</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 128); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">public void</span> <span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">onReceiveRequestVoteRpc(RequestVoteRpcMessage rpcMessage) {</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">    context</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.taskExecutor().submit(</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">       () -&gt;</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-weight: bold;">context</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">.connector().replyRequestVote(doProcessRequestVoteRpc(</span><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace;">rpcMessage</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">),</span> <span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace;">rpcMessage</span><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">),</span></div><div style="background-color: rgb(255, 255, 255); font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(102, 14, 122); font-family: &quot;JetBrains Mono&quot;, monospace; font-style: italic; font-weight: bold;">    LOGGING_FUTURE_CALLBACK</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">    );</span></div><div style="font-size: 9.8pt;"><span style="font-size: 9.8pt; color: rgb(0, 0, 0); font-family: &quot;JetBrains Mono&quot;, monospace;">}</span></div><div><br/></div><div>43、①IO线程和处理逻辑之间加一个间接层 ，比如处理队列。</div><div>②异步IO库——netty</div><div><br/></div><div>44、①netty的NIO处理模型图</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">保证处理逻辑——单线程</span></div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">自带队列和单线程机制：</span><span style="color: rgb(222, 87, 0); font-weight: bold;">处理逻辑可以安全地单线程执行，同时IO线程也不会被阻塞（因为有队列）</span></div><div>ExecutorService executorService =Executors.newSingleThreadExecutor();</div><div>executorService.submit( ( ) -&gt;{    //处理逻辑</div><div>    }</div><div><span style="font-size: unset; color: unset; font-family: unset;">)</span></div><div>④Executors.newSingleThreadExecutor();的好处</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">【1】处理逻辑抛出异常，线程是否会退出？</span></div><div>【2】线程退出后，是否会重建？——SingleThreadExecutor，<span style="color: rgb(222, 87, 0); font-weight: bold;">线程退出后，会自动重建</span></div><div>⑤<span style="color: rgb(50, 135, 18); font-weight: bold;">单线程的好处：线程封闭，不需要锁机制</span></div><div><br/></div><div>45、多线程分析</div><div>①<span style="color: rgb(222, 87, 0); font-weight: bold;">并不是【简单地分析什么地方该使用锁，什么地方该使用队列，因为这些只是解决问题的手段】</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">可以将多线程理解为【构建一个操作和数据变更的表】</span></div><div>②<span style="color: rgb(227, 0, 0); font-weight: bold;"> raft核心算法中的5个基本操作——【有图表】</span></div><div>③<span style="color: rgb(50, 135, 18); font-weight: bold;">两阶段所：读写锁</span></div><div>④找出比较独立的数据：比如复制进度</div><div><br/></div><div>46、①日志IO：或许可以并行</div><div>②本书没有实现异步日志IO</div><div>③<span style="color: rgb(222, 87, 0); font-weight: bold;">日志</span><span style="color: rgb(222, 87, 0); font-weight: bold;">异步化，【</span><span style="color: rgb(222, 87, 0); font-weight: bold;">可能</span><span style="color: rgb(222, 87, 0); font-weight: bold;">】会破坏raft核心算法的正确性前提</span></div><div>④<span style="color: rgb(227, 0, 0); font-weight: bold;">日志追加的方式@@</span></div><div>【1】本书采用</div><div>【2】</div><div>【3】</div><div><br/></div><div>47、①增加commitIndex必须在异步写入之后</div><div>【1】异步化</div><div>【2】有先后顺序</div><div>②<span style="color: rgb(222, 87, 0); font-weight: bold;">异步转同步：Future.get</span></div><div><span style="color: rgb(227, 0, 0); font-weight: bold;">③两个图的意思？？？</span></div><div><br/></div><div>48、<span style="color: rgb(50, 135, 18); font-weight: bold;">整体线程设计</span></div><div>①node：主线程</div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">②state-machine：状态机</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">③scheduler：定时器</span></div><div>④group-config-change：集群配置更改，专用线程</div><div><br/></div><div>49、protocol buffer</div><div><br/></div><div>53、依赖的库</div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">①guava</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">②protobuf-Java</span></div><div><span style="color: rgb(50, 135, 18); font-weight: bold;">③commons-cli</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">④jline</span></div><div><span style="color: rgb(222, 87, 0); font-weight: bold;">⑤Junit</span></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 